<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Status Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1976d2;
            --primary-dark: #1565c0;
            --secondary-color: #03dac6;
            --background: #fafafa;
            --surface: #ffffff;
            --on-surface: #212121;
            --on-surface-variant: #757575;
            --outline: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.12);
            --status-online: #4caf50;
            --status-offline: #9e9e9e;
            --status-busy: #ff5722;
            --status-full: #9c27b0;
            --ping-good: #4caf50;
            --ping-medium: #ff9800;
            --ping-bad: #f44336;
            --elevation-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --elevation-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --elevation-3: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
        }

        .dark-theme {
            --background: #121212;
            --surface: #1e1e1e;
            --on-surface: #ffffff;
            --on-surface-variant: #b0b0b0;
            --outline: #333333;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background);
            color: var(--on-surface);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 100vh;
        }

        .navbar-brand {
            font-weight: 600;
            color: var(--primary-color) !important;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .navbar-nav .nav-link {
            color: var(--primary-color) !important;
            font-weight: 500;
            transition: color 0.2s;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            color: var(--primary-color) !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            max-width: 400px;
            margin: 0 auto;
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--elevation-1);
            transition: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            box-shadow: var(--elevation-2);
        }

        .stat-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--on-surface-variant);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .stat-subtitle {
            font-size: 12px;
            color: var(--on-surface-variant);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .server-list {
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--elevation-1);
        }

        .server-list-header {
            padding: 20px 24px;
            background: var(--primary-color);
            color: white;
            font-weight: 500;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .server-item {
            padding: 16px 24px;
            border-bottom: 1px solid var(--outline);
            transition: background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .server-item:hover {
            background-color: rgba(0, 0, 0, 0.04);
        }

        .dark-theme .server-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .server-item:last-child {
            border-bottom: none;
        }

        .server-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .server-name {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            font-size: 16px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
        }

        .status-online { background-color: var(--status-online); }
        .status-offline { background-color: var(--status-offline); }
        .status-busy { background-color: var(--status-busy); }
        .status-full { background-color: var(--status-full); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .ping-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }

        .ping-good { background-color: var(--ping-good); }
        .ping-medium { background-color: var(--ping-medium); }
        .ping-bad { background-color: var(--ping-bad); }

        .server-details {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .usage-info {
            flex: 1;
            min-width: 0;
        }

        .usage-text {
            font-size: 14px;
            color: var(--on-surface-variant);
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 6px;
            background-color: var(--outline);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-low { background: linear-gradient(90deg, var(--status-online), #66bb6a); }
        .progress-medium { background: linear-gradient(90deg, var(--ping-medium), #ffb74d); }
        .progress-high { background: linear-gradient(90deg, var(--ping-bad), #ef5350); }
        .progress-full { background: linear-gradient(90deg, var(--status-full), #ab47bc); }

        .flag {
            width: 24px;
            height: 16px;
            border-radius: 2px;
            object-fit: cover;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .retry-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .retry-btn:hover {
            background: var(--primary-dark);
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: var(--elevation-3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .fab:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .last-update {
            text-align: center;
            color: var(--on-surface-variant);
            font-size: 12px;
            margin-top: 16px;
            padding: 12px;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            height: 16px;
            margin: 8px 0;
        }

        .dark-theme .loading-skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
            background-size: 200% 100%;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .error-state {
            color: var(--ping-bad);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .server-item {
                padding: 16px;
            }

            .server-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .server-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .fab {
                bottom: 16px;
                right: 16px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .server-item {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="https://raw.githubusercontent.com/sansoe2022/image_store/refs/heads/main/icon.png" alt="SVPN Logo" style="width:36px; height:auto;">
                SVPN
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#svpnNavbar" aria-controls="svpnNavbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="svpnNavbar">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" href="guidesim.html">
                            <i class="bi bi-journal-code me-1"></i> VPN နဲ့ ချိတ်သုံးဖို့ လမ်းညွှန်
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="extendsim.html">
                            <i class="bi bi-phone me-1"></i> ဆင်းမ်ကဒ် သက်တမ်းတိုးနည်း
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-house-door me-1"></i> Home
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">Total Online Users</div>
                <div class="stat-value" id="totalOnlineCount">0</div>
                <div class="stat-subtitle">
                    <span class="material-icons" style="font-size: 16px;">people</span>
                    Active connections
                </div>
            </div>
        </div>

        <div class="server-list">
            <div class="server-list-header">
                <span class="material-icons">list</span>
                Server Status List
            </div>
            <div id="serverContainer">
                <div class="server-item">
                    <div class="loading-skeleton"></div>
                    <div class="loading-skeleton" style="width: 60%; margin-top: 12px;"></div>
                </div>
            </div>
        </div>

        <div class="last-update" id="lastUpdated">
            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">update</span>
            Last updated: --
        </div>
    </div>

    <button class="fab" id="themeToggle">
        <span class="material-icons">dark_mode</span>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- [ပြင်ဆင်ချက်] URLs Array ပုံစံပြောင်းထားသည် ---
        const servers = [
            { 
                id: 'th-01', 
                name: 'Thailand-01', 
                urls: [
                    'http://free1svpn.sksvpn.shop:81/server/online',
                    'http://free1svpn.sksvpn.shop:81/udpserver/online'
                ] 
            },
            { 
                id: 'th-02', 
                name: 'Thailand-02', 
                urls: [
                    'http://free2svpn.sksvpn.shop:81/server/online',
                    'http://free2svpn.sksvpn.shop:81/udpserver/online'
                ] 
            },
            { 
                id: 'th-03', 
                name: 'Thailand-03', 
                urls: [
                    'http://free3svpn.sksvpn.shop:81/server/online',
                    'http://free3svpn.sksvpn.shop:81/udpserver/online'
                ] 
            }
        ];

        const SERVER_USER_LIMIT = 250;
        const corsProxies = [
            url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            url => `https://corsproxy.org/?${encodeURIComponent(url)}`,
            url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
        ];

        // Utility functions
        function getCountryCode(serverId) {
            return serverId.split('-')[0] || 'th';
        }

        function getFlagImage(countryCode) {
            const code = countryCode.toLowerCase();
            return `https://flagcdn.com/w40/${code}.png`;
        }

        function getPingClass(pingTime) {
            if (pingTime <= 100) return 'ping-good';
            if (pingTime <= 300) return 'ping-medium';
            return 'ping-bad';
        }

        function getServerStatus(onlineCount) {
            if (onlineCount === 0) {
                return { status: 'Offline', class: 'status-offline', icon: 'cloud_off' };
            } else if (onlineCount >= SERVER_USER_LIMIT) {
                return { status: 'Full', class: 'status-full', icon: 'people' };
            } else if (onlineCount > SERVER_USER_LIMIT * 0.8) {
                return { status: 'Busy', class: 'status-busy', icon: 'warning' };
            } else {
                return { status: 'Online', class: 'status-online', icon: 'cloud_done' };
            }
        }

        function getProgressBarClass(percentage) {
            if (percentage < 50) return 'progress-low';
            if (percentage < 80) return 'progress-medium';
            if (percentage < 100) return 'progress-high';
            return 'progress-full';
        }

        async function fetchWithCorsProxy(url, proxyIndex = 0) {
            if (proxyIndex >= corsProxies.length) {
                throw new Error('All CORS proxies failed');
            }
            
            const proxyUrl = corsProxies[proxyIndex](url);
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                const response = await fetch(proxyUrl, {
                    signal: controller.signal,
                    headers: { 'Accept': 'text/plain' }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response;
            } catch (error) {
                if (proxyIndex < corsProxies.length - 1) {
                    return fetchWithCorsProxy(url, proxyIndex + 1);
                }
                throw error;
            }
        }

        async function updateServerStatus() {
            const container = document.getElementById('serverContainer');
            const totalOnlineCountElement = document.getElementById('totalOnlineCount');
            const lastUpdatedElement = document.getElementById('lastUpdated');

            let totalOnlineCount = 0;

            container.innerHTML = '';

            const serverPromises = servers.map(async (server) => {
                const serverElement = document.createElement('div');
                serverElement.className = 'server-item';
                // Initial Loading UI
                serverElement.innerHTML = `
                    <div class="server-header">
                        <div class="server-name">
                            <div class="status-indicator status-offline"></div>
                            <img src="${getFlagImage(getCountryCode(server.id))}" alt="Flag" class="flag" onerror="this.style.display='none'">
                            <span>${server.name}</span>
                        </div>
                        <div class="ping-badge ping-bad">Checking...</div>
                    </div>
                    <div class="server-details">
                        <div class="usage-info">
                            <div class="usage-text">Checking server status...</div>
                            <div class="progress-bar">
                                <div class="progress-fill progress-low" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(serverElement);

                try {
                    const startTime = Date.now();
                    
                    // --- [ပြင်ဆင်ချက်] Loop through all URLs and Sum them up ---
                    const urlPromises = server.urls.map(url => fetchWithCorsProxy(url));
                    const responses = await Promise.all(urlPromises);
                    
                    let combinedOnlineCount = 0;
                    
                    for (const response of responses) {
                        const responseText = await response.text();
                        const count = parseInt(responseText, 10);
                        if (!isNaN(count)) {
                            combinedOnlineCount += count;
                        }
                    }

                    if (combinedOnlineCount > SERVER_USER_LIMIT) {
                        combinedOnlineCount = SERVER_USER_LIMIT;
                    }
                    
                    const pingTime = Date.now() - startTime;

                    totalOnlineCount += combinedOnlineCount;

                    const statusInfo = getServerStatus(combinedOnlineCount);
                    const pingClass = getPingClass(pingTime);
                    const percentage = Math.min(100, Math.round((combinedOnlineCount / SERVER_USER_LIMIT) * 100));
                    const progressBarClass = getProgressBarClass(percentage);

                    serverElement.innerHTML = `
                        <div class="server-header">
                            <div class="server-name">
                                <div class="status-indicator ${statusInfo.class}"></div>
                                <img src="${getFlagImage(getCountryCode(server.id))}" alt="Flag" class="flag" onerror="this.style.display='none'">
                                <span>${server.name}</span>
                            </div>
                            <div class="ping-badge ${pingClass}">${pingTime}ms</div>
                        </div>
                        <div class="server-details">
                            <div class="usage-info">
                                <div class="usage-text">${combinedOnlineCount}/${SERVER_USER_LIMIT} users (${percentage}%)</div>
                                <div class="progress-bar">
                                    <div class="progress-fill ${progressBarClass}" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </div>
                    `;

                } catch (error) {
                    // console.error(error); // Debug if needed
                    serverElement.innerHTML = `
                        <div class="server-header">
                            <div class="server-name">
                                <div class="status-indicator status-offline"></div>
                                <img src="${getFlagImage(getCountryCode(server.id))}" alt="Flag" class="flag" onerror="this.style.display='none'">
                                <span>${server.name}</span>
                            </div>
                            <div class="ping-badge ping-bad">Error</div>
                        </div>
                        <div class="server-details">
                            <div class="error-state">
                                <span class="material-icons" style="font-size: 16px;">error</span>
                                Connection failed
                                <button class="retry-btn" onclick="retryServer('${server.id}')">Retry</button>
                            </div>
                        </div>
                    `;
                }
            });

            await Promise.allSettled(serverPromises);

            totalOnlineCountElement.textContent = totalOnlineCount;

            const now = new Date();
            const options = {
                timeZone: 'Asia/Bangkok',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            const formatter = new Intl.DateTimeFormat('en-US', options);
            const parts = formatter.formatToParts(now);
            const formattedDate = `${parts.find(p => p.type === 'year').value}-${parts.find(p => p.type === 'month').value}-${parts.find(p => p.type === 'day').value} ${parts.find(p => p.type === 'hour').value}:${parts.find(p => p.type === 'minute').value}:${parts.find(p => p.type === 'second').value}`;
            
            lastUpdatedElement.innerHTML = `
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">update</span>
                Last updated: ${formattedDate} (Bangkok Time)
            `;
        }

        async function retryServer(serverId) {
            const server = servers.find(s => s.id === serverId);
            if (!server) return;

            const serverElements = document.querySelectorAll('.server-item');
            const serverElement = Array.from(serverElements).find(el => 
                el.textContent.includes(server.name)
            );
            
            if (!serverElement) return;

            serverElement.innerHTML = `
                <div class="server-header">
                    <div class="server-name">
                        <div class="status-indicator status-offline"></div>
                        <img src="${getFlagImage(getCountryCode(server.id))}" alt="Flag" class="flag" onerror="this.style.display='none'">
                        <span>${server.name}</span>
                    </div>
                    <div class="ping-badge ping-bad">Retrying...</div>
                </div>
                <div class="server-details">
                    <div class="loading-skeleton"></div>
                </div>
            `;

            try {
                const startTime = Date.now();
                
                // Retry logic for multiple URLs
                const urlPromises = server.urls.map(url => fetchWithCorsProxy(url));
                const responses = await Promise.all(urlPromises);
                
                let combinedOnlineCount = 0;
                for (const response of responses) {
                    const responseText = await response.text();
                    const count = parseInt(responseText, 10);
                    if (!isNaN(count)) combinedOnlineCount += count;
                }
                
                if (combinedOnlineCount > SERVER_USER_LIMIT) {
                    combinedOnlineCount = SERVER_USER_LIMIT;
                }
                
                const pingTime = Date.now() - startTime;

                const statusInfo = getServerStatus(combinedOnlineCount);
                const pingClass = getPingClass(pingTime);
                const percentage = Math.min(100, Math.round((combinedOnlineCount / SERVER_USER_LIMIT) * 100));
                const progressBarClass = getProgressBarClass(percentage);

                serverElement.innerHTML = `
                    <div class="server-header">
                        <div class="server-name">
                            <div class="status-indicator ${statusInfo.class}"></div>
                            <img src="${getFlagImage(getCountryCode(server.id))}" alt="Flag" class="flag" onerror="this.style.display='none'">
                            <span>${server.name}</span>
                        </div>
                        <div class="ping-badge ${pingClass}">${pingTime}ms</div>
                    </div>
                    <div class="server-details">
                        <div class="usage-info">
                            <div class="usage-text">${combinedOnlineCount}/${SERVER_USER_LIMIT} users (${percentage}%)</div>
                            <div class="progress-bar">
                                <div class="progress-fill ${progressBarClass}" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                serverElement.innerHTML = `
                    <div class="server-header">
                        <div class="server-name">
                            <div class="status-indicator status-offline"></div>
                            <img src="${getFlagImage(getCountryCode(server.id))}" alt="Flag" class="flag" onerror="this.style.display='none'">
                            <span>${server.name}</span>
                        </div>
                        <div class="ping-badge ping-bad">Error</div>
                    </div>
                    <div class="server-details">
                        <div class="error-state">
                            <span class="material-icons" style="font-size: 16px;">error</span>
                            Connection failed
                            <button class="retry-btn" onclick="retryServer('${server.id}')">Retry</button>
                        </div>
                    </div>
                `;
            }
        }

        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            
            document.body.className = savedTheme === 'dark' ? 'dark-theme' : '';
            updateThemeButton();
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeButton();
        }

        function updateThemeButton() {
            const button = document.getElementById('themeToggle');
            const isDark = document.body.classList.contains('dark-theme');
            button.innerHTML = `<span class="material-icons">${isDark ? 'light_mode' : 'dark_mode'}</span>`;
        }

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        initTheme();
        updateServerStatus();

        setInterval(updateServerStatus, 30000); 
    </script>
</body>
</html>
